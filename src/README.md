# Scripts and Source Files

Descriptions can also be found in the script files or by running `<script> -h`.

--------------------------------------
script_order.txt

PacBio preprocessing:
Run `deconcatenation.py` on the PacBio CCS Q20 file
Run Lima on the deconcatenated output

Nanopore and Pacbio libraries are then sent through LAST commands to extract conserved regions.

Run `filterMaf.py` on the output from LAST to only include records with the correct conserved regions

The resulting libraries should be sent through the `extractRegionsFasta_withEnds.py` to extract barcodes and genes

run the barcodes and genes through `starcode.script` to make barcode clusters

then the barcode gene results will go into `lammassemble.script` to align barcode clusters

those files go into `final_output_MSA.py` to generate the format requested for the final output

the lib 4 and lib 5 results from those can go into `quality_binning.py` to generate the confidence groups that the Plesa lab is using


--------------------------------------



## Details

### `deconcatenation.py`
`deconcatenation.py` deconcatenates reads into "monomers" including the indexes, conserved regions, gene, and barcode.

#### Inputs
* A FASTQ file containing raw concatenated reads

#### Outputs
* A FASTQ file containing deconcatenated reads. 
    * New records produced from splitting raw records into monomers have a numerical suffix appended to the header to maintain unique read IDs.

#### Options

`-f`, `--file`: Path to the input FASTQ file containing concatenated reads.

`-o`, `--output`: Name of the output file containing deconcatenated reads.

`-s`, `--sequences`: Path to a FASTA file containing sequences of 3 conserved regions.


### `extractRegionsFasta_withEnds.py`
`extractRegionsFasta_withEnds.py` extracts reads and barcodes from monomers. This version of the script allows for barcodes that are 19-21 nt in length but requires "CR1" to end with ATG.

#### Inputs
* A FASTA file containing records that have been preprocessed to contain one monomer per read.
* A MAF file that has been filtered to contain only reads with all 3 conserved regions.

#### Outputs
* A FASTA file containing extracted barcode sequences (`*_barcodes.fasta`)
* A FASTA file containing extracted gene sequences (`*_genes.fasta`)
* A FASTA file containing paired gene and barcode sequences (`*_concat.fasta`)
* A TSV file containing sequence counts (`*_counts.tsv`)
* A TSV file containing a distribution of sequence counts (`*_dist.tsv`)

#### Options

`-f`, `--fasta`: Path to the raw fasta file

`-m`, `--maf`: maf file from LAST already having been run through `filterMaf.py`

`-o`, `--outBase`: The base filename of the output, replaces the `*` in filenames listed in Outputs


## `filterMaf.py`
`filterMaf.py` filters the multiple alignment format output from LAST to only contain records with all three conserved regions

#### Inputs
* A MAF file generated by LAST

#### Outputs
* A MAF file that only contains entries for reads that have "CR1", "CR2", and "CR3" aligned to them

#### Options

`-i`, `--inFile`: input MAF file

`-o`, `--outFile`: output MAF file

### `final_output_MSA.py`
`final_output_MSA.py` takes the output from `runLamassemble.py` to create the final output tsv.

#### Inputs
* The fasta output from `runLamassemble.py`

#### Outputs
* A csv containing the barcode sequence, number of instances, dna sequence, aa sequence from start to first stop, aa sequence including stop codons, and the name of the source file 

#### Options
`-f`: Path to the fasta file produced by `runLamassemble.py`

`-o`: name of the csv to be generated


### `runLamassemble.py`
`runLamassemble.py` generates a consensus sequence for the variable regions in a barcode cluster.

#### Inputs
* A fasta containing only the genes/variable regions (`*_genes.fasta` output by `extractRegionsFasta_withEnds.py`)
* The text file generated by starcode showing the barcode cluster sequence and indeces of fasta records in the cluster

#### Outputs
* A fasta with headers in the format `>{barcode}_{number of instances}` and the consensus sequence of all genes in the cluster. This sequence can be empty if lamassemble detects that the sequences are too different from each other.

#### Options
`-f`, `--fasta`: Fasta only containing variable regions

`-s`, `--starcodedBarcodes`: The starcode output file for the barcodes

`-o`, `--output`: Fasta containing consensus sequences, singletons will have the sequence exactly as it appeared

`-t`, `--tempFile`: A temporary fasta that will contain the gene sequences of a single barcode cluster. This is appended to, overwritten, and removed at the end, so it should have a unique name within the directory it is being run in.

### `summarize_maf.py`
`summarize_maf.py` creates a summary of the number of conserved regions per read in a multiple alignment file.

#### Inputs
* The fasta file that was aligned using LAST
* The maf output file from LAST

#### Outputs
* A text file containing some potentially useful information about the alignment quality of a sample. It contains the number of instances of each conserved region, and the number of reads which each count of conserved regions. In ideal circumstances, all reads would have only CR1, CR2, and CR3, but real data has reads either missing conserved regions or with extra occurances of one or more conserved region.

#### Options
`-f`, `--fasta`: The raw fasta file used as input to LAST

`-m`, `--maf`: The maf file generated by LAST

`-o`, `--output`: The name of the text file to be generated

### `summary_stats_hist.py`
`summary_stats_hist.py` creates summary statistics and a histogram of read lengths in a FASTX file.

#### Input
* Fasta/fastq file to be summarized
* A string showing which file type the input is, either `fasta` or `fastq`

#### Outputs
* A text file with the number of sequences in the fasta/fastq file
* A png of a histogram of sequence lengths

#### Options
`-f`, `--infile`: Path to the FASTX file

`-o`, `--outname`: base filename for the outputs, \*.txt and \*.png 

`-t`, `--filetype`: type of the FASTX file, either `fasta` or `fastq`
